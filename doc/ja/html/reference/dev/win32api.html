<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<TITLE>Win32API</TITLE>
<META http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" href="../../style.css" type="text/css">
</HEAD>
<BODY>

<h1>Win32API</h1>

Win32API に関するメモ

<h2 id="ini_file">iniファイル</h2>

<p>
  Windows 2000(NT3?) ごろに Unicode 対応版 WritePrivateProfileStringW()
  等が実装されたと思われます。
</p>

<p>
  iniファイルの文字コードや Unicode/ANSI を混在して使用していた場合のドキュメントは見当たらないため動作をまとめました。
  最近のWindows(少なくともWindows 10,11)では、Unicode に対応するため次のような動作となっています。
</p>

<ul>
  <li>ファイルの先頭に UTF-16LE BOM (0xff 0xfe) がついているとき、iniファイルは Unicode のファイルとして扱われます。</li>
  <li>ANSI/Unicode API で Unicode/非Unicode iniファイルを読み書きしたとき、自動で ACP/Unicode 変換が行わます(9x系では行われません)。</li>
  <ul>
    <li>Unicode ini ファイルのとき、Unicode として読み書きします。</li>
    <li>Unicode ini ファイルではないとき、日本語環境では Shift_JIS(ACP) として読み書きします。</li>
    <li>このため ini ファイルの文字コードによらず透過的に API を利用できます。</li>
    <li>Unicode ではない ini ファイルに Shift_JIS で表現できない Unicode 文字を書き込むと"?"に置換されて書き込まれます。</li>
  </ul>
  <li>Unicode API で書き込んで新規にファイルが作成されたときは Unicode ini ファイルになりません。</li>
  <li>BOM (0xff 0xfe) だけの空ファイルを作っておいて、そのファイルに Unicode API で書き込むと Unicode ini ファイルになります。</li>
</ul>

</html>
